[2025-05-13 22:09:55,358][__main__][INFO] - Initializing data provider
[2025-05-13 22:09:55,360][data.provider.data_bento.databento_file_provider][INFO] - Scanning for metadata in '/Users/fx/Repositories/FxAIv2/dnb/mlgo'...
[2025-05-13 22:09:55,365][data.provider.data_bento.databento_file_provider][INFO] - Found 6 directories, indexed 183 files
[2025-05-13 22:09:55,365][__main__][INFO] - Setting up simulator
[2025-05-13 22:09:55,366][__main__][INFO] - Loading data for MLGO from 2025-03-27 to 2025-03-27
[2025-05-13 22:09:55,367][__main__][INFO] - Initializing market from 2025-03-27 00:00:00 to 2025-03-27 23:59:59
[2025-05-13 22:09:55,367][__main__][INFO] - Loading data for MLGO from 2025-03-27 00:00:00+00:00 to 2025-03-27 23:59:59.999999+00:00
[2025-05-13 22:09:55,367][__main__][INFO] - Loading bars_1s from provider for MLGO
[2025-05-13 22:09:55,964][data.provider.data_bento.databento_file_provider][INFO] - Loaded 6466 1s bars for MLGO
[2025-05-13 22:09:55,964][__main__][INFO] - Loaded 6466 rows of bars_1s data for MLGO
[2025-05-13 22:09:55,964][__main__][INFO] - Loading bars_1m from provider for MLGO
[2025-05-13 22:09:56,106][data.provider.data_bento.databento_file_provider][INFO] - Loaded 571 1m bars for MLGO
[2025-05-13 22:09:56,106][__main__][INFO] - Loaded 571 rows of bars_1m data for MLGO
[2025-05-13 22:09:56,106][__main__][INFO] - Loading bars_5m from provider for MLGO
[2025-05-13 22:09:56,106][data.provider.data_bento.databento_file_provider][INFO] - No 5m bar files found for MLGO
[2025-05-13 22:09:56,106][data.provider.data_bento.databento_file_provider][INFO] - No direct 5m bars found for MLGO, building from 1m bars
[2025-05-13 22:09:56,113][data.provider.data_bento.databento_file_provider][INFO] - Loaded 571 1m bars for MLGO
[2025-05-13 22:09:56,119][data.provider.data_bento.databento_file_provider][INFO] - Built 159 5m bars from 1m bars for MLGO
[2025-05-13 22:09:56,119][__main__][INFO] - Loaded 159 rows of bars_5m data for MLGO
[2025-05-13 22:09:56,119][__main__][INFO] - Loading bars_1d from provider for MLGO
[2025-05-13 22:09:56,128][data.provider.data_bento.databento_file_provider][INFO] - Loaded 1 1d bars for MLGO
[2025-05-13 22:09:56,128][__main__][INFO] - Loaded 1 rows of bars_1d data for MLGO
[2025-05-13 22:09:56,128][__main__][INFO] - Loading trades from provider for MLGO
[2025-05-13 22:09:58,991][data.provider.data_bento.databento_file_provider][INFO] - Loaded 21111 trades for MLGO
[2025-05-13 22:09:58,991][__main__][INFO] - Loaded 21111 rows of trades data for MLGO
[2025-05-13 22:09:58,991][__main__][INFO] - Loading quotes from provider for MLGO
[2025-05-13 22:10:41,582][data.provider.data_bento.databento_file_provider][INFO] - Loaded 193387 quotes for MLGO
[2025-05-13 22:10:41,585][__main__][INFO] - Loaded 193387 rows of quotes data for MLGO
[2025-05-13 22:10:41,585][__main__][INFO] - Loading status from provider for MLGO
[2025-05-13 22:10:41,767][data.provider.data_bento.databento_file_provider][INFO] - Loaded 6 status records for MLGO
[2025-05-13 22:10:41,767][__main__][INFO] - Loaded 6 rows of status data for MLGO
[2025-05-13 22:10:41,767][__main__][INFO] - Data for MLGO is not a DataFrame type: <class 'dict'>
[2025-05-13 22:10:41,767][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:41,767][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:41,767][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:41,767][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:41,768][__main__][INFO] - Extracting features for MLGO
[2025-05-13 22:10:41,768][__main__][WARNING] - No features extracted for MLGO
[2025-05-13 22:10:41,768][__main__][INFO] - Creating trading environment
[2025-05-13 22:10:41,781][__main__][INFO] - Using device: mps
[2025-05-13 22:10:41,781][__main__][INFO] - Creating multi-branch transformer model
[2025-05-13 22:10:41,826][__main__][INFO] - Model config: {'hf_seq_len': 60, 'hf_feat_dim': 20, 'mf_seq_len': 30, 'mf_feat_dim': 15, 'lf_seq_len': 30, 'lf_feat_dim': 10, 'static_feat_dim': 15, 'd_model': 64, 'd_fused': 256, 'hf_layers': 2, 'mf_layers': 2, 'lf_layers': 2, 'hf_heads': 4, 'mf_heads': 4, 'lf_heads': 4, 'action_dim': 1, 'continuous_action': True, 'dropout': 0.1}
[2025-05-13 22:10:41,826][__main__][INFO] - Model structure: MultiBranchTransformer(
  (hf_proj): Linear(in_features=20, out_features=64, bias=True)
  (hf_pos_enc): PositionalEncoding(
    (dropout): Dropout(p=0.1, inplace=False)
  )
  (hf_encoder): TransformerEncoder(
    (layers): ModuleList(
      (0-1): 2 x TransformerEncoderLayer(
        (self_attn): MultiheadAttention(
          (out_proj): NonDynamicallyQuantizableLinear(in_features=64, out_features=64, bias=True)
        )
        (linear1): Linear(in_features=64, out_features=128, bias=True)
        (dropout): Dropout(p=0.1, inplace=False)
        (linear2): Linear(in_features=128, out_features=64, bias=True)
        (norm1): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (norm2): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (dropout1): Dropout(p=0.1, inplace=False)
        (dropout2): Dropout(p=0.1, inplace=False)
        (activation): GELU(approximate='none')
      )
    )
    (norm): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
  )
  (mf_proj): Linear(in_features=15, out_features=64, bias=True)
  (mf_pos_enc): PositionalEncoding(
    (dropout): Dropout(p=0.1, inplace=False)
  )
  (mf_encoder): TransformerEncoder(
    (layers): ModuleList(
      (0-1): 2 x TransformerEncoderLayer(
        (self_attn): MultiheadAttention(
          (out_proj): NonDynamicallyQuantizableLinear(in_features=64, out_features=64, bias=True)
        )
        (linear1): Linear(in_features=64, out_features=128, bias=True)
        (dropout): Dropout(p=0.1, inplace=False)
        (linear2): Linear(in_features=128, out_features=64, bias=True)
        (norm1): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (norm2): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (dropout1): Dropout(p=0.1, inplace=False)
        (dropout2): Dropout(p=0.1, inplace=False)
        (activation): GELU(approximate='none')
      )
    )
    (norm): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
  )
  (lf_proj): Linear(in_features=10, out_features=64, bias=True)
  (lf_pos_enc): PositionalEncoding(
    (dropout): Dropout(p=0.1, inplace=False)
  )
  (lf_encoder): TransformerEncoder(
    (layers): ModuleList(
      (0-1): 2 x TransformerEncoderLayer(
        (self_attn): MultiheadAttention(
          (out_proj): NonDynamicallyQuantizableLinear(in_features=64, out_features=64, bias=True)
        )
        (linear1): Linear(in_features=64, out_features=128, bias=True)
        (dropout): Dropout(p=0.1, inplace=False)
        (linear2): Linear(in_features=128, out_features=64, bias=True)
        (norm1): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (norm2): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (dropout1): Dropout(p=0.1, inplace=False)
        (dropout2): Dropout(p=0.1, inplace=False)
        (activation): GELU(approximate='none')
      )
    )
    (norm): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
  )
  (static_encoder): Sequential(
    (0): Linear(in_features=15, out_features=64, bias=True)
    (1): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
    (2): GELU(approximate='none')
    (3): Linear(in_features=64, out_features=64, bias=True)
    (4): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
    (5): GELU(approximate='none')
  )
  (fusion): AttentionFusion(
    (self_attention): MultiheadAttention(
      (out_proj): NonDynamicallyQuantizableLinear(in_features=64, out_features=64, bias=True)
    )
    (proj): Sequential(
      (0): Linear(in_features=256, out_features=256, bias=True)
      (1): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
      (2): GELU(approximate='none')
      (3): Dropout(p=0.1, inplace=False)
    )
  )
  (actor): ActorNetwork(
    (shared): Sequential(
      (0): Linear(in_features=256, out_features=256, bias=True)
      (1): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
      (2): GELU(approximate='none')
      (3): Linear(in_features=256, out_features=256, bias=True)
      (4): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
      (5): GELU(approximate='none')
    )
    (mean): Linear(in_features=256, out_features=1, bias=True)
  )
  (critic): CriticNetwork(
    (critic): Sequential(
      (0): Linear(in_features=256, out_features=256, bias=True)
      (1): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
      (2): GELU(approximate='none')
      (3): Linear(in_features=256, out_features=256, bias=True)
      (4): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
      (5): GELU(approximate='none')
      (6): Linear(in_features=256, out_features=1, bias=True)
    )
  )
)
[2025-05-13 22:10:42,085][__main__][ERROR] - Error during model forward pass: 'tuple' object has no attribute 'shape'
[2025-05-13 22:10:42,087][__main__][INFO] - Setting up PPO trainer
[2025-05-13 22:10:42,748][__main__][INFO] - PPO Trainer initialized on device: mps
[2025-05-13 22:10:42,748][__main__][INFO] - Model: MultiBranchTransformer
[2025-05-13 22:10:42,748][__main__][INFO] - Learning rate: 0.0003
[2025-05-13 22:10:42,748][__main__][INFO] - Starting training for 100 updates
[2025-05-13 22:10:42,748][__main__][INFO] - Starting training for 100 updates
[2025-05-13 22:10:44,770][__main__][INFO] - Update 1/100
[2025-05-13 22:10:44,770][__main__][INFO] - Collecting 8 episodes...
[2025-05-13 22:10:44,772][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:44,773][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:44,773][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:44,824][__main__][INFO] - SELL order filled: 96 shares @ $9.9500
[2025-05-13 22:10:44,824][__main__][INFO] - Market order 1000 (sell) filled: 96 shares @ $9.9500
[2025-05-13 22:10:44,825][__main__][INFO] - Reached end of data
[2025-05-13 22:10:44,825][__main__][INFO] - Episode 1 finished: 1 steps, reward: 1910.40, PnL: $1910.40
[2025-05-13 22:10:44,825][__main__][INFO] - Episode finished - PnL: $1910.40 (1.91%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:44,932][__main__][INFO] - Episode 1: reward=-0.10, length=1
[2025-05-13 22:10:44,933][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:44,933][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:44,933][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:44,947][__main__][INFO] - SELL order filled: 51 shares @ $9.9500
[2025-05-13 22:10:44,948][__main__][INFO] - Market order 1000 (sell) filled: 51 shares @ $9.9500
[2025-05-13 22:10:44,948][__main__][INFO] - Reached end of data
[2025-05-13 22:10:44,948][__main__][INFO] - Episode 2 finished: 1 steps, reward: 1014.90, PnL: $1014.90
[2025-05-13 22:10:44,948][__main__][INFO] - Episode finished - PnL: $1014.90 (1.01%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:44,950][__main__][INFO] - Episode 2: reward=-0.10, length=1
[2025-05-13 22:10:44,951][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:44,951][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:44,951][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:44,967][__main__][INFO] - SELL order filled: 72 shares @ $9.9500
[2025-05-13 22:10:44,968][__main__][INFO] - Market order 1000 (sell) filled: 72 shares @ $9.9500
[2025-05-13 22:10:44,968][__main__][INFO] - Reached end of data
[2025-05-13 22:10:44,968][__main__][INFO] - Episode 3 finished: 1 steps, reward: 1432.80, PnL: $1432.80
[2025-05-13 22:10:44,968][__main__][INFO] - Episode finished - PnL: $1432.80 (1.43%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:44,970][__main__][INFO] - Episode 3: reward=-0.10, length=1
[2025-05-13 22:10:44,971][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:44,971][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:44,971][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:44,985][__main__][INFO] - SELL order filled: 38 shares @ $9.9500
[2025-05-13 22:10:44,985][__main__][INFO] - Market order 1000 (sell) filled: 38 shares @ $9.9500
[2025-05-13 22:10:44,985][__main__][INFO] - Reached end of data
[2025-05-13 22:10:44,985][__main__][INFO] - Episode 4 finished: 1 steps, reward: 756.20, PnL: $756.20
[2025-05-13 22:10:44,985][__main__][INFO] - Episode finished - PnL: $756.20 (0.76%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:44,988][__main__][INFO] - Episode 4: reward=-0.10, length=1
[2025-05-13 22:10:44,988][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:44,988][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:44,989][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:45,002][__main__][INFO] - SELL order filled: 96 shares @ $9.9500
[2025-05-13 22:10:45,002][__main__][INFO] - Market order 1000 (sell) filled: 96 shares @ $9.9500
[2025-05-13 22:10:45,002][__main__][INFO] - Reached end of data
[2025-05-13 22:10:45,002][__main__][INFO] - Episode 5 finished: 1 steps, reward: 1910.40, PnL: $1910.40
[2025-05-13 22:10:45,002][__main__][INFO] - Episode finished - PnL: $1910.40 (1.91%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:45,004][__main__][INFO] - Episode 5: reward=-0.10, length=1
[2025-05-13 22:10:45,557][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:45,557][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:45,557][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:45,572][__main__][INFO] - BUY order filled: 83 shares @ $10.0500
[2025-05-13 22:10:45,572][__main__][INFO] - Market order 1000 (buy) filled: 83 shares @ $10.0500
[2025-05-13 22:10:45,572][__main__][INFO] - Reached end of data
[2025-05-13 22:10:45,572][__main__][INFO] - Episode 6 finished: 1 steps, reward: 0.00, PnL: $0.00
[2025-05-13 22:10:45,572][__main__][INFO] - Episode finished - PnL: $0.00 (0.00%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:45,575][__main__][INFO] - Episode 6: reward=-0.10, length=1
[2025-05-13 22:10:45,576][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:45,576][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:45,576][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:45,589][__main__][INFO] - BUY order filled: 66 shares @ $10.0500
[2025-05-13 22:10:45,589][__main__][INFO] - Market order 1000 (buy) filled: 66 shares @ $10.0500
[2025-05-13 22:10:45,589][__main__][INFO] - Reached end of data
[2025-05-13 22:10:45,589][__main__][INFO] - Episode 7 finished: 1 steps, reward: 0.00, PnL: $0.00
[2025-05-13 22:10:45,589][__main__][INFO] - Episode finished - PnL: $0.00 (0.00%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:45,592][__main__][INFO] - Episode 7: reward=-0.10, length=1
[2025-05-13 22:10:45,593][__main__][WARNING] - WARNING: Could not find valid price data, using default values
[2025-05-13 22:10:45,593][__main__][INFO] - Market initialized: Price=$10.0000, Bid=$9.9500, Ask=$10.0500, Spread=$0.1000
[2025-05-13 22:10:45,593][__main__][INFO] - Resetting to timestamp: None
[2025-05-13 22:10:45,608][__main__][INFO] - SELL order filled: 89 shares @ $9.9500
[2025-05-13 22:10:45,608][__main__][INFO] - Market order 1000 (sell) filled: 89 shares @ $9.9500
[2025-05-13 22:10:45,608][__main__][INFO] - Reached end of data
[2025-05-13 22:10:45,608][__main__][INFO] - Episode 8 finished: 1 steps, reward: 1771.10, PnL: $1771.10
[2025-05-13 22:10:45,609][__main__][INFO] - Episode finished - PnL: $1771.10 (1.77%), Win Rate: 0.0%, Trades: 0
[2025-05-13 22:10:45,612][__main__][INFO] - Episode 8: reward=-0.10, length=1
[2025-05-13 22:10:45,624][__main__][INFO] - Computing advantages - rewards: torch.Size([8, 1]), values: torch.Size([8, 1]), dones: torch.Size([8, 1])
